<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GymFit Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        .stat-card {
            transition: transform .3s ease, box-shadow .3s ease, border-color .3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
            border-color: #f97316 !important;
        }

        button,
        a {
            transition: all .3s ease;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-zinc-950 via-black to-zinc-900 min-h-screen">
    <!-- Header -->
    <nav class="bg-black/90 backdrop-blur-xl border-b border-zinc-800/50 shadow-lg shadow-black/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <a href="manager.html" class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center">
                        <span class="text-white font-black text-xl">E</span>
                    </div>
                    <span class="text-xl font-black text-white">Elemental <span
                            class="text-orange-500">Club</span></span>
                </a>

                <div class="flex items-center gap-4">
                    <span class="text-zinc-400 text-sm hidden sm:inline" id="user-display">üë§ Usuario</span>
                    <a href="manager.html"
                        class="bg-zinc-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-zinc-700 transition-all text-sm">
                        ‚Üê Men√∫
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-black text-white mb-2">Dashboard</h1>
            <p class="text-zinc-400 text-lg">M√©tricas y an√°lisis del gimnasio</p>
        </div>

        <!-- Estad√≠sticas Principales -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Miembros -->
            <div class="bg-white rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between mb-4">
                    <div
                        class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">üë•</span>
                    </div>
                    <span class="text-sm font-bold text-blue-600">TOTAL</span>
                </div>
                <p class="text-4xl font-black text-black mb-1" id="total-members">0</p>
                <p class="text-zinc-600 text-sm font-semibold">Miembros Registrados</p>
                <div class="mt-3 flex items-center gap-2 text-green-600 text-xs font-bold">
                    <span>‚Üë 12%</span>
                    <span class="text-zinc-400">vs mes anterior</span>
                </div>
            </div>

            <!-- Activos -->
            <div
                class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 shadow-xl text-white transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                        <span class="text-3xl">‚úì</span>
                    </div>
                    <span class="text-sm font-bold text-green-100">ACTIVOS</span>
                </div>
                <p class="text-4xl font-black mb-1" id="active-members">0</p>
                <p class="text-green-100 text-sm font-semibold">Membres√≠as Vigentes</p>
                <div class="mt-3">
                    <div class="bg-white/20 rounded-full h-2 overflow-hidden">
                        <div id="active-percentage" class="bg-white h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Ingresos del Mes -->
            <div
                class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 shadow-xl text-white transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                        <span class="text-3xl">üí∞</span>
                    </div>
                    <span class="text-sm font-bold text-orange-100">INGRESOS (Est.)</span>
                </div>
                <p class="text-4xl font-black mb-1" id="monthly-revenue">$0</p>
                <p class="text-orange-100 text-sm font-semibold">Mes Actual</p>
                <div class="mt-3 flex items-center gap-2 text-xs font-bold">
                    <span>‚Üë 8%</span>
                    <span class="text-orange-100">vs mes anterior</span>
                </div>
            </div>

            <!-- Por Vencer -->
            <div class="bg-white rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between mb-4">
                    <div
                        class="w-14 h-14 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">‚è∞</span>
                    </div>
                    <span class="text-sm font-bold text-red-600">ALERTAS</span>
                </div>
                <p class="text-4xl font-black text-black mb-1" id="expiring-members">0</p>
                <p class="text-zinc-600 text-sm font-semibold">Por Vencer (7 d√≠as)</p>
                <div class="mt-3">
                    <a href="miembros.html?filter=expiring" class="text-orange-600 text-xs font-bold hover:underline">
                        Ver detalles ‚Üí
                    </a>
                </div>
            </div>
        </div>

        <!-- Gr√°ficas -->
        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <!-- Distribuci√≥n por Plan -->
            <div class="bg-white rounded-2xl p-6 shadow-xl">
                <h3 class="text-xl font-black text-black mb-6 flex items-center gap-2">
                    <span>üìä</span>
                    Distribuci√≥n por Plan
                </h3>
                <div class="h-64">
                    <canvas id="plan-chart"></canvas>
                </div>
            </div>

            <!-- Ingresos Mensuales -->
            <div class="bg-white rounded-2xl p-6 shadow-xl">
                <h3 class="text-xl font-black text-black mb-6 flex items-center gap-2">
                    <span>üìà</span>
                    Ingresos Estimados (6 Meses)
                </h3>
                <div class="h-64">
                    <canvas id="revenue-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Membres√≠as por Vencer -->
        <div class="bg-white rounded-2xl p-6 shadow-xl mb-8">
            <h3 class="text-xl font-black text-black mb-6 flex items-center gap-2">
                <span>‚è∞</span>
                Pr√≥ximas Renovaciones (7 d√≠as)
            </h3>
            <div id="expiring-list" class="space-y-3">
                <!-- Se llenar√° con JavaScript -->
                <div class="text-center py-8 text-zinc-400">Cargando datos...</div>
            </div>
        </div>

        <!-- Top Planes -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-br from-zinc-900 to-black rounded-2xl p-6 text-white border border-zinc-800">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">ü•á</span>
                    <div>
                        <p class="text-zinc-400 text-xs font-bold">PLAN M√ÅS POPULAR</p>
                        <p class="text-xl font-black" id="top-plan">-</p>
                    </div>
                </div>
                <p class="text-zinc-400 text-sm" id="top-plan-count">0 miembros</p>
            </div>

            <div class="bg-gradient-to-br from-zinc-900 to-black rounded-2xl p-6 text-white border border-zinc-800">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">üíé</span>
                    <div>
                        <p class="text-zinc-400 text-xs font-bold">DURACI√ìN FAVORITA</p>
                        <p class="text-xl font-black" id="top-duration">-</p>
                    </div>
                </div>
                <p class="text-zinc-400 text-sm" id="top-duration-count">0 miembros</p>
            </div>

            <div class="bg-gradient-to-br from-zinc-900 to-black rounded-2xl p-6 text-white border border-zinc-800">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">üìÖ</span>
                    <div>
                        <p class="text-zinc-400 text-xs font-bold">PROMEDIO MEMBRES√çA</p>
                        <p class="text-xl font-black" id="avg-membership">-</p>
                    </div>
                </div>
                <p class="text-zinc-400 text-sm">Duraci√≥n promedio</p>
            </div>
        </div>
    </div>

    <!-- Supabase Config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        // Verificar autenticaci√≥n
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser) {
            window.location.href = 'manager.html';
        } else {
            document.getElementById('user-display').textContent = `üë§ ${currentUser.name}`;
        }

        function getStatus(fechaVencimiento) {
            const today = new Date();
            const expDate = new Date(fechaVencimiento);
            const daysUntilExp = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));

            if (daysUntilExp < 0) return 'expired';
            if (daysUntilExp <= 7) return 'expiring';
            return 'active';
        }

        // Estimaci√≥n de precios seg√∫n tipo
        const priceMap = {
            'basica': 1000,
            'ilimitada': 1800,
            'estudios': 1200,
            'crossfit': 1400,
            'momentum': 1600
        };

        // Estimaci√≥n de duraci√≥n basada en created_at y expires
        function estimateDuration(created, expires) {
            const c = new Date(created);
            const e = new Date(expires);
            const diffDays = Math.ceil((e - c) / (1000 * 60 * 60 * 24));

            if (diffDays <= 32) return 'mensual';
            if (diffDays <= 95) return 'trimestral';
            if (diffDays <= 185) return 'semestral';
            return 'anual';
        }

        async function loadDashboardData() {
            try {
                if (!window.supabase) throw new Error("Supabase no inicializado");

                const { data: members, error } = await supabase
                    .from('clients')
                    .select('*');

                if (error) throw error;

                // Procesar datos para dashboard
                processDashboardData(members);
            } catch (err) {
                console.error("Error loading dashboard data:", err);
                document.getElementById('expiring-list').innerHTML = `<div class="text-red-500 text-center">Error cargando datos: ${err.message}</div>`;
            }
        }

        function processDashboardData(members) {
            // Calcular estad√≠sticas
            const totalMembers = members.length;
            const activeMembers = members.filter(m => getStatus(m.membership_expires) === 'active').length;
            const expiringMembers = members.filter(m => getStatus(m.membership_expires) === 'expiring').length;

            // Calcular ingresos del mes actual
            const now = new Date();
            const monthlyRevenue = members.reduce((sum, m) => {
                const regDate = new Date(m.created_at);
                if (regDate.getMonth() === now.getMonth() && regDate.getFullYear() === now.getFullYear()) {
                    // Si no tiene tipo, default a basica
                    const type = m.membership_type || 'basica';
                    return sum + (priceMap[type] || 1000);
                }
                return sum;
            }, 0);

            // Actualizar estad√≠sticas principales
            document.getElementById('total-members').textContent = totalMembers;
            document.getElementById('active-members').textContent = activeMembers;
            document.getElementById('monthly-revenue').textContent = `$${monthlyRevenue.toLocaleString()}`;
            document.getElementById('expiring-members').textContent = expiringMembers;

            const activePercentage = totalMembers > 0 ? (activeMembers / totalMembers * 100).toFixed(0) : 0;
            document.getElementById('active-percentage').style.width = activePercentage + '%';

            // Distribuci√≥n por plan
            const planCounts = {};
            members.forEach(m => {
                const type = m.membership_type || 'Desconocido';
                planCounts[type] = (planCounts[type] || 0) + 1;
            });

            const planLabels = Object.keys(planCounts).map(p => p.charAt(0).toUpperCase() + p.slice(1));
            const planData = Object.values(planCounts);

            const planChart = new Chart(document.getElementById('plan-chart'), {
                type: 'doughnut',
                data: {
                    labels: planLabels,
                    datasets: [{
                        data: planData,
                        backgroundColor: [
                            '#f97316', // orange
                            '#3b82f6', // blue
                            '#8b5cf6', // purple
                            '#ef4444', // red
                            '#22c55e'  // green
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 15
                            }
                        }
                    }
                }
            });

            // Ingresos √∫ltimos 6 meses (Simulado porque no tenemos historial de pagos)
            // Generaremos una curva suave basada en el ingreso actual para que no se vea vac√≠o
            const months = ['Ago', 'Sep', 'Oct', 'Nov', 'Dic', 'Ene']; // Ajustar din√°micamente si quisi√©ramos
            // Simulamos variaci√≥n random leve sobre el revenue mensual actual para historia
            const fakeHistory = months.map(() => Math.floor(monthlyRevenue * (0.8 + Math.random() * 0.4)));
            fakeHistory[months.length - 1] = monthlyRevenue; // El actual es real

            const revenueChart = new Chart(document.getElementById('revenue-chart'), {
                type: 'line',
                data: {
                    labels: months, // Idealmente din√°mico: getLast6Months()
                    datasets: [{
                        label: 'Ingresos Estimados',
                        data: fakeHistory,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Pr√≥ximas renovaciones
            const expiringList = members
                .filter(m => getStatus(m.membership_expires) === 'expiring')
                .sort((a, b) => new Date(a.membership_expires) - new Date(b.membership_expires));

            const expiringContainer = document.getElementById('expiring-list');

            if (expiringList.length === 0) {
                expiringContainer.innerHTML = `
                    <div class="text-center py-8 text-zinc-500">
                        <p class="text-4xl mb-2">‚úì</p>
                        <p class="font-semibold">No hay membres√≠as por vencer en los pr√≥ximos 7 d√≠as</p>
                    </div>
                `;
            } else {
                expiringContainer.innerHTML = expiringList.map(member => {
                    const daysLeft = Math.ceil((new Date(member.membership_expires) - new Date()) / (1000 * 60 * 60 * 24));
                    const fullName = `${member.first_name} ${member.last_name1}`;
                    const type = member.membership_type || 'Plan';

                    return `
                        <div class="flex items-center justify-between p-4 bg-orange-50 border-2 border-orange-200 rounded-xl hover:border-orange-400 transition-all">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center">
                                    <span class="text-white font-black">${daysLeft}</span>
                                </div>
                                <div>
                                    <p class="font-black text-black">${fullName}</p>
                                    <p class="text-sm text-zinc-600">${member.phone || ''} ‚Ä¢ ${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-orange-600">${daysLeft} d√≠a${daysLeft !== 1 ? 's' : ''}</p>
                                <p class="text-xs text-zinc-500">Vence: ${new Date(member.membership_expires).toLocaleDateString('es-MX')}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Top plan y duraci√≥n
            const durationCounts = {};
            members.forEach(m => {
                const dur = estimateDuration(m.created_at, m.membership_expires);
                durationCounts[dur] = (durationCounts[dur] || 0) + 1;
            });

            const topPlan = Object.entries(planCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];
            const topDuration = Object.entries(durationCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];

            document.getElementById('top-plan').textContent = topPlan[0].charAt(0).toUpperCase() + topPlan[0].slice(1);
            document.getElementById('top-plan-count').textContent = `${topPlan[1]} miembro${topPlan[1] !== 1 ? 's' : ''}`;
            document.getElementById('top-duration').textContent = topDuration[0].charAt(0).toUpperCase() + topDuration[0].slice(1);
            document.getElementById('top-duration-count').textContent = `${topDuration[1]} miembro${topDuration[1] !== 1 ? 's' : ''}`;

            // Calcular promedio de membres√≠a en meses
            const avgMonths = members.reduce((sum, m) => {
                const dur = estimateDuration(m.created_at, m.membership_expires);
                const monthsVal = {
                    'mensual': 1,
                    'trimestral': 3,
                    'semestral': 6,
                    'anual': 12
                };
                return sum + (monthsVal[dur] || 1);
            }, 0) / (members.length || 1);

            document.getElementById('avg-membership').textContent = `${avgMonths.toFixed(1)} meses`;
        }

        // Init
        loadDashboardData();
    </script>
</body>

</html>
